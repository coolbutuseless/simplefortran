---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)

library(simplefortran)
```

# simplefortran - demo package for calling C code with `.C()`

<!-- badges: start -->
![](https://img.shields.io/badge/cool-useless-green.svg)
<!-- badges: end -->

`simplefortran` is a small demo package showing how Fortran code could be included
in a package and called with `.Fortran()`

This is one of a series of small demo packages for  
calling other languages from R:

* [{simplec}](https://github.com/coolbutuseless/simplec) - calling C with `.C()`
* [{simplecall}](https://github.com/coolbutuseless/simplecall) - calling C with `.Call()`
* [{simplercpp}](https://github.com/coolbutuseless/simplercpp) - calling C++ with `{Rcpp}`
* [{simplefortran}](https://github.com/coolbutuseless/simplefortran) - calling Fortran with `.Fortran()`


## Rough comparison of `.C()`, `.Call()`, `{Rcpp}`  (and `.Fortran()`)

|                | .C()                                                   | .Call()                                                      | Rcpp                                                         |
|----------------|--------------------------------------------------------|--------------------------------------------------------------|--------------------------------------------------------------|
| Overview       | No real understanding of R objects                     | Need to understand SEXP macros & internals                   | C++ classes hide the complexity of the SEXP internals        |
| What code?     | Basic C code. Numeric calcs.                           | Complex C code. Can manipulate R objects from C              | Complex C and C++ code involving numerics and R objects      |
| Pros           | Simple to understand and use                           | Simple. No unnecessary copying.                              | Great documentation.  Wrapping of R objects very intuitive.  |
| Cons           | Too simple for most interesting things                 | Need to understand SEXP & R internals                        |                                                              |
| Cons           | Performs copying of data to call functions             |                                                              |                                                              |
| Demo R package | [{simplec}](https://github.com/coolbutuseless/simplec) | [{simplecall}](https://github.com/coolbutuseless/simplecall) | [{simplercpp}](https://github.com/coolbutuseless/simplercpp) |
| Compiled size  |  17 kB                                                 |   17 kB                                                      | 92 kB  (stripping can bring this down: see [issue1](https://github.com/coolbutuseless/simplercpp/issues/1))|



|                | .Fortran()                                                         |
|----------------|--------------------------------------------------------------------|
| Overview       | No real understanding of R objects                                 |
| What code?     | Basic Fortran code. Numeric calcs.                                 |
| Pros           | Simple to understand and use                                       |
| Cons           | Too simple for most interesting things                             |
| Cons           | Performs copying of data to call functions                         |
| Cons           | Need to know Fortran!                                              |
| Demo R package | [{simplefortran}](https://github.com/coolbutuseless/simplefortran) |
| Compiled size  |  17 kB                                                             |



## Installation

You can install from [GitHub](https://github.com/coolbutuseless/simplefortran) with:

``` r
# install.package('remotes')
remotes::install_github('coolbutuseless/simplefortran)
```

## What's in the box?

Package contains 2 Fortran functions, and 2 functions in R which call the Fortran functions 
using `.Fortran()`.

| Fortran function                          | R function           |
|-------------------------------------------|----------------------|
| `subroutine add_(x, y, answer)`           | `add_Fortran(x, y)`  |
| `subroutine mul_(x, y, answer)`           | `mul_Fortran(x, y)`  |



## What's in the R functions?

* A call using `.Fortran()`
* First argument is the Fortran function name e.g. `add_`
* `x` and `y` arguments are passed through from the R function
* the third argument to the function is space in which to store the result 
  i.e. `numeric(1)`
* `.Fortran()` returns as many arguments as you gave it originally
* We only want to return the actual result, which is the third argument, 
  hence `[[3]]`
* `@useDynLib [packagename] [Fortran function name]` is used to generate the NAMESPACE
  entry `useDynLib(simplefortran, add_)`

```{r eval = FALSE}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#' Add two numbers
#'
#' @param x,y numbers to add
#'
#' @useDynLib simplefortran add_
#' @export
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
add_Fortran <- function(x, y) {
  .Fortran(add_, x, y, numeric(1))[[3]]
}
```


## What's in the Fortran functions?

* Actual result must be stored in one of the arguments

```
        subroutine add_(x, y, answer)
c
c add 2 numbers
c
        double precision x, y, answer

        answer = x + y

        end
```


## How do R variables map to Fortran variables?

* See [R manual on writing Extensions](https://cran.r-project.org/doc/manuals/R-exts.html#Interface-functions-_002eC-and-_002eFortran) for more info

| R         | Fortran          |
|-----------|------------------|
| logical   | INTEGER          |
| integer   | INTEGER          |
| double    | DOUBLE PRECISION |
| complex   | DOUBLE COMPLEX   |
| character | CHARACTER(255)   |
| raw       | (none)           |





## What does the Fortran function look like in R?

* An object of class `NativeSymbolInfo`
* Holds an `externalptr` to the loaded function

```{r}
simplefortran:::add_
```




## Resources

* [Peter Dalgaard's Keynote from UseR 2004](http://www.ci.tuwien.ac.at/Conferences/useR-2004/Keynotes/Dalgaard.pdf) 
discusses R's language interfaces
* [Using R — Calling C Code ‘Hello World’](http://mazamascience.com/WorkingWithData/?p=1067)
* [Hadley's Advanced R book chapter - 'Rs C interface'](http://adv-r.had.co.nz/C-interface.html)
* [Rcpp](https://cran.r-project.org/package=Rcpp)

## Acknowledgements

* R Core for developing and maintaining such a wonderful language.
* CRAN maintainers, for patiently shepherding packages onto CRAN and maintaining
  the repository
